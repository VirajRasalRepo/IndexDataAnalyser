<!DOCTYPE html>
<html>
<head>
    <title>Nifty Live Terminal</title>
    <link href="https://cdn.datatables.net/v/bs5/jszip-3.10.1/dt-1.13.6/b-2.4.2/b-html5-2.4.2/cr-1.7.0/datatables.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body { border: 6px solid #0d6efd; min-height: 100vh; background-color: #121212; color: white; margin: 0; padding: 0; }
        .table-xs { font-size: 0.68rem; width: 100% !important; }

        /* Controls Panel */
        .controls {
            position: fixed; bottom: 20px; right: 30px; z-index: 2000;
            background: rgba(0, 0, 0, 0.95); padding: 15px; border-radius: 10px;
            border: 2px solid #0d6efd; width: 210px;
        }
        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; border-bottom: 1px solid #444; padding-bottom: 5px; }
        .toggle-btn { padding: 0 10px; font-weight: bold; cursor: pointer; }

        /* Row & Header Styling */
        .group-blue td { background-color: #87CEFA !important; color: #000 !important; }
        .group-black td { background-color: #f6f4f4 !important; color: #0b0a0a !important; }
        .highlight-16 { background-color: #4B0082 !important; color: white !important; font-weight: bold !important; }

        .sticky-header th { color: white !important; cursor: move; border: 1px solid #444 !important; font-size: 0.7rem; }
        .ce-head { background-color: #ffcccb !important; color: black !important; }
        .pe-head { background-color: #90ee90 !important; color: black !important; }
        .neutral-head { background-color: #0d6efd !important; color: white !important; }
        .strike-col { background-color: #d3d3d3 !important; color: black !important; font-weight: bold !important; }
        .diff-col { font-weight: bold !important; background-color: #222 !important; }

        /* SIDE-BY-SIDE FILTER FIX */
        .filter-header { background-color: #000000 !important; }
        .filter-header th {
            background-color: #a39f9f !important;
            padding: 4px !important;
            border: 1px solid #f3efef !important;
            /* Enable Flexbox for side-by-side layout */
            display: table-cell;
            vertical-align: middle;
        }

        /* Container inside TH to hold Dropdown + Sorting */
        .filter-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 5px;
        }

        /* Adjust DataTables Sorting Arrows for side-by-side */
        table.dataTable thead .sorting,
        table.dataTable thead .sorting_asc,
        table.dataTable thead .sorting_desc {
            background-image: none !important; /* Hide default icons to use flex-friendly ones */
            padding-right: 20px !important;
        }

        /* Styling the Dropdown */
        .filter-header select {
            background-color: #1a1a1a !important;
            color: #ffffff !important;
            border: 1px solid #0d6efd !important;
            font-size: 0.6rem;
            border-radius: 3px;
            flex-grow: 1; /* Dropdown takes available space */
            min-width: 40px;
        }

        .dt-buttons, .dataTables_filter { display: none !important; }
    </style>
</head>
<body>

    <div class="controls text-center" id="controlPanel">
        <div class="panel-header">
            <div class="small text-warning">Sync: <strong id="syncTime">...</strong></div>
            <button class="btn btn-outline-info btn-sm toggle-btn" onclick="toggleControls()">–</button>
        </div>
        <div id="controlsBody">
            <button id="refreshBtn" class="btn btn-danger btn-sm w-100 mt-2 mb-2" onclick="toggleRefresh()">Stop Refresh</button>
            <button class="btn btn-secondary btn-sm w-100 mb-2" onclick="toggleFilters()">Show Filters</button>
            <button id="btnExcel" class="btn btn-success btn-sm w-100 mb-2">Export Excel</button>
            <div class="mb-2 text-start">
                <label class="small d-block mb-1 text-center">Arrange Columns:</label>
                <select id="layoutSelect" class="form-select form-select-sm mb-2" onchange="changeLayout(this.value)">
                    <option value="default">Default View</option>
                    <option value="greeks">Greeks Focus</option>
                    <option value="oi_vol">OI & Volume Focus</option>
                </select>
            </div>
            <button class="btn btn-outline-light btn-sm w-100" onclick="resetLayout()">Reset Layout</button>
        </div>
    </div>

    <div class="container-fluid mt-1">
        <table id="mainTable" class="table table-bordered text-center table-xs nowrap">
            <thead class="sticky-header">
                <tr id="titleRow">
                    <th class="neutral-head">Date</th><th class="neutral-head">Time</th><th class="neutral-head">Spot</th>
                    <th class="ce-head">CE_OI</th><th class="ce-head">CE_Vol</th><th class="ce-head">CE_IV</th>
                    <th class="ce-head">CE_Δ</th><th class="ce-head">CE_γ</th><th class="ce-head">CE_θ</th><th class="ce-head">CE_Price</th>
                    <th class="strike-col">STRIKE</th><th class="diff-col">OI DIFF</th>
                    <th class="pe-head">PE_Price</th><th class="pe-head">PE_θ</th><th class="pe-head">PE_γ</th>
                    <th class="pe-head">PE_Δ</th><th class="pe-head">PE_IV</th><th class="pe-head">PE_Vol</th><th class="pe-head">PE_OI</th>
                </tr>
                <tr id="filterRow" class="filter-header" style="display: none;">
                    <th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/v/bs5/jszip-3.10.1/dt-1.13.6/b-2.4.2/b-html5-2.4.2/cr-1.7.0/datatables.min.js"></script>

    <script>
        let isPaused = false;
        let table;

        function toggleControls() {
            const body = $('#controlsBody');
            const btn = $('.toggle-btn');
            if (body.is(':visible')) { body.hide(); btn.text('+'); $('#controlPanel').css('width', '120px'); }
            else { body.show(); btn.text('–'); $('#controlPanel').css('width', '210px'); }
        }

        $(document).ready(function() {
            table = $('#mainTable').DataTable({
                ajax: { url: "/get_data", dataSrc: "data" },
                dom: 'lBrtip',
                buttons: [{
                    extend: 'excelHtml5',
                    title: () => 'Nifty_Export_' + new Date().toISOString().replace(/[:.]/g, '-'),
                    exportOptions: { columns: ':visible', orthogonal: 'export', modifier: { page: 'all' } }
                }],
                columns: [
                    { data: "date" }, { data: "time" }, { data: "spot_price" },
                    { data: "ce_oi", render: (d, t) => t==='display'?(d?Number(d).toLocaleString():"0"):d },
                    { data: "ce_volume", render: (d, t) => t==='display'?(d?Number(d).toLocaleString():"0"):d },
                    { data: "ce_iv" }, { data: "ce_delta" }, { data: "ce_gamma" }, { data: "ce_theta" }, { data: "ce_price" },
                    { data: "strike_price", className: "strike-col" },
                    {
                        data: "oi_diff", className: "diff-col",
                        render: (d, t) => t==='display'?(d?Number(d).toLocaleString():"0"):d,
                        createdCell: (td, d) => { let v = parseFloat(d); if(v<0) $(td).css('color','#ff4d4d'); else if(v>0) $(td).css('color','#00ff00'); }
                    },
                    { data: "pe_price" }, { data: "pe_theta" }, { data: "pe_gamma" }, { data: "pe_delta" }, { data: "pe_iv" },
                    { data: "pe_volume", render: (d, t) => t==='display'?(d?Number(d).toLocaleString():"0"):d },
                    { data: "pe_oi", render: (d, t) => t==='display'?(d?Number(d).toLocaleString():"0"):d }
                ],
                colReorder: true,
                order: [[1, "desc"]],
                pageLength: 31,
                lengthMenu: [[10, 31, 50, 100, 500, 1000, -1], [10, 31, 50, 100, 500, 1000, "All"]],
                createdRow: function(row, data, dataIndex) {
                    if (dataIndex + 1 === 16 || (dataIndex + 1 > 16 && (dataIndex + 1 - 16) % 31 === 0)) $(row).addClass('highlight-16');
                    else $(row).addClass(Math.floor(dataIndex / 31) % 2 === 0 ? 'group-blue' : 'group-black');
                },
                initComplete: function () {
                    this.api().columns().every(function (index) {
                        var column = this;
                        // Create a container for side-by-side layout
                        var container = $('<div class="filter-container"></div>').appendTo($(`#filterRow th`).eq(index));
                        var select = $('<select><option value="">All</option></select>')
                            .appendTo(container)
                            .on('change', function () { column.search($(this).val()).draw(); });
                        column.data().unique().sort().each(d => { if(d) select.append(`<option value="${d}">${d}</option>`); });
                    });
                }
            });

            $('#btnExcel').on('click', () => table.button(0).trigger());
            setInterval(() => { if (!isPaused) table.ajax.reload(null, false); }, 4000);
        });

        function changeLayout(v) {
            let o = v === 'default' ? [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18] :
                    v === 'greeks' ? [1,10,11,6,7,8,13,14,15,0,2,3,4,5,9,12,16,17,18] :
                    [1,10,11,3,4,17,18,0,2,5,6,7,8,9,12,13,14,15,16];
            table.colReorder.order(o, true);
        }
        function resetLayout() { table.colReorder.reset(); window.location.reload(); }
        function toggleFilters() { $('#filterRow').toggle(); table.columns.adjust().draw(); }
        function toggleRefresh() { isPaused = !isPaused; $('#refreshBtn').toggleClass('btn-danger btn-success').text(isPaused ? "Start" : "Stop"); }
    </script>
</body>
</html>