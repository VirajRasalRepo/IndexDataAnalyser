<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Nifty Live Terminal - Smart Filters</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css"/>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css"/>

    <style>
        body { border: 6px solid #0d6efd; min-height: 100vh; background-color: #121212; color: white; margin: 0; padding: 0; }
        .table-xs { font-size: 0.68rem; width: 100% !important; }

        .controls {
            position: fixed; bottom: 20px; right: 30px; z-index: 2000;
            background: rgba(0, 0, 0, 0.95); padding: 15px; border-radius: 10px;
            border: 2px solid #0d6efd; width: 210px;
        }
        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; border-bottom: 1px solid #444; padding-bottom: 5px; }

        .min-btn {
            background: none; border: 1px solid #444; color: #ffc107;
            border-radius: 4px; padding: 0 8px; font-weight: bold; cursor: pointer;
            font-size: 0.8rem;
        }
        .min-btn:hover { background: #333; }

        .group-blue td { background-color: #87CEFA !important; color: #000 !important; }
        .group-black td { background-color: #f6f4f4 !important; color: #0b0a0a !important; }
        .highlight-16 { background-color: #4B0082 !important; color: white !important; font-weight: bold !important; }

        .sticky-header th { color: white !important; border: 1px solid #444 !important; font-size: 0.7rem; background-color: #0d6efd; vertical-align: middle; }
        .ce-head { background-color: #ffcccb !important; color: black !important; }
        .pe-head { background-color: #90ee90 !important; color: black !important; }
        .strike-col { background-color: #d3d3d3 !important; color: black !important; font-weight: bold !important; }
        .diff-col { font-weight: bold !important; background-color: #222 !important; }

        .filter-row th { background-color: #1a1a1a !important; padding: 2px !important; }
        .column-select {
            width: 100%;
            font-size: 0.6rem;
            background: #222;
            color: #00ff00;
            border: 1px solid #444;
            border-radius: 2px;
            outline: none;
        }

        .dt-buttons, .dataTables_filter { display: none !important; }

        .dataTables_length label { color: #ffc107; font-size: 0.75rem; width: 100%; }
        .dataTables_length select {
            background: #222 !important;
            color: white !important;
            border: 1px solid #0d6efd !important;
            font-size: 0.75rem;
            padding: 2px;
            width: 100%;
            margin-top: 5px;
        }
    </style>
</head>
<body>

    <div class="controls text-center" id="controlPanel">
        <div class="panel-header">
            <div class="small text-warning">Sync: <strong id="syncTime">...</strong></div>
            <button class="min-btn" id="togglePanelBtn" onclick="toggleControlPanel()">−</button>
        </div>
        <div id="controlsBody">
            <button id="refreshBtn" class="btn btn-danger btn-sm w-100 mt-2 mb-2" onclick="toggleRefresh()">Stop Refresh</button>
            <button id="btnExcel" class="btn btn-success btn-sm w-100 mb-2">Export Excel</button>
            <button class="btn btn-outline-warning btn-sm w-100 mb-2" onclick="clearAllFilters()">Clear Filters</button>
            <div class="mb-2 text-start">
                <label class="small d-block mb-1 text-center">Layout:</label>
                <select id="layoutSelect" class="form-select form-select-sm mb-2" onchange="changeLayout(this.value)">
                    <option value="default">Default</option>
                    <option value="greeks">Greeks</option>
                    <option value="oi_vol">OI & Vol</option>
                </select>
            </div>
            <button class="btn btn-outline-light btn-sm w-100" onclick="resetLayout()">Reset</button>
        </div>
    </div>

    <div class="container-fluid mt-2">
        <table id="mainTable" class="table table-bordered text-center table-xs nowrap">
            <thead class="sticky-header">
                <tr id="titleRow">
                    <th>Date</th><th>Time</th><th>Spot</th>
                    <th class="ce-head">CE_OI</th><th class="ce-head">CE_Vol</th><th class="ce-head">CE_IV</th>
                    <th class="ce-head">CE_Δ</th><th class="ce-head">CE_γ</th><th class="ce-head">CE_θ</th><th class="ce-head">CE_Price</th>
                    <th class="strike-col">STRIKE</th><th class="diff-col">OI DIFF</th>
                    <th class="pe-head">PE_Price</th><th class="pe-head">PE_θ</th><th class="pe-head">PE_γ</th>
                    <th class="pe-head">PE_Δ</th><th class="pe-head">PE_IV</th><th class="pe-head">PE_Vol</th><th class="pe-head">PE_OI</th>
                </tr>
                <tr class="filter-row" id="filterRow">
                    <th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th>
                    <th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>

    <script>
        let isPaused = false;
        let table;

        $(document).ready(function() {
            table = $('#mainTable').DataTable({
                ajax: { url: "/get_data", dataSrc: "data" },
                dom: 'lBrtip',
                lengthMenu: [[31, 100, 500, 1000, 2000], [31, 100, 500, 1000, 2000]],
                pageLength: 31,
                buttons: [
                    {
                        extend: 'excelHtml5',
                        // Dynamic filename logic
                        filename: function() {
                            const now = new Date();
                            const date = now.toISOString().split('T')[0]; // YYYY-MM-DD
                            const time = now.getHours().toString().padStart(2, '0') + "-" +
                                         now.getMinutes().toString().padStart(2, '0') + "-" +
                                         now.getSeconds().toString().padStart(2, '0');
                            return 'Nifty_Live_Terminal_' + date + '_' + time;
                        },
                        title: 'Nifty Live Terminal Data',
                        exportOptions: {
                            columns: ':visible',
                            format: {
                                header: function (data, columnIdx) {
                                    return $('#titleRow th').eq(columnIdx).text();
                                }
                            }
                        }
                    }
                ],
                columns: [
                    { data: "date" }, { data: "time" }, { data: "spot_price" },
                    { data: "ce_oi", render: (d, t) => t==='display'?(d?Number(d).toLocaleString():"0"):d },
                    { data: "ce_volume", render: (d, t) => t==='display'?(d?Number(d).toLocaleString():"0"):d },
                    { data: "ce_iv" }, { data: "ce_delta" }, { data: "ce_gamma" }, { data: "ce_theta" }, { data: "ce_price" },
                    { data: "strike_price", className: "strike-col" },
                    {
                        data: "oi_diff", className: "diff-col",
                        render: (d, t) => t==='display'?(d?Number(d).toLocaleString():"0"):d,
                        createdCell: (td, d) => {
                            let v = parseFloat(d);
                            if(v < 0) $(td).css('color','#ff4d4d'); else if(v > 0) $(td).css('color','#00ff00');
                        }
                    },
                    { data: "pe_price" }, { data: "pe_theta" }, { data: "pe_gamma" }, { data: "pe_delta" }, { data: "pe_iv" },
                    { data: "pe_volume", render: (d, t) => t==='display'?(d?Number(d).toLocaleString():"0"):d },
                    { data: "pe_oi", render: (d, t) => t==='display'?(d?Number(d).toLocaleString():"0"):d }
                ],
                order: [[1, "desc"]],
                initComplete: function() {
                    createDropdowns(this.api());
                    $('.dataTables_length').prependTo('#controlsBody');
                },
                drawCallback: function() {
                    updateDropdowns(this.api());
                },
                createdRow: function(row, data, dataIndex) {
                    if (dataIndex + 1 === 16 || (dataIndex + 1 > 16 && (dataIndex + 1 - 16) % 31 === 0)) $(row).addClass('highlight-16');
                    else $(row).addClass(Math.floor(dataIndex / 31) % 2 === 0 ? 'group-blue' : 'group-black');
                }
            });

            table.on('xhr', function() {
                const now = new Date();
                $('#syncTime').text(now.toLocaleTimeString());
            });

            $('#btnExcel').on('click', function() {
                // This triggers the first button in the buttons collection (the excel button)
                table.button(0).trigger();
            });

            setInterval(function() {
                if (!isPaused) {
                    table.ajax.reload(null, false);
                }
            }, 5000);
        });

        function toggleControlPanel() {
            const body = $('#controlsBody');
            const btn = $('#togglePanelBtn');
            body.slideToggle('fast', function() {
                btn.text(body.is(':visible') ? '−' : '+');
            });
        }

        function createDropdowns(api) {
            api.columns().every(function() {
                let column = this;
                let select = $('<select class="column-select"><option value="">All</option></select>')
                    .appendTo($('#filterRow th').eq(column.index()).empty())
                    .on('change', function() {
                        let val = $.fn.dataTable.util.escapeRegex($(this).val());
                        column.search(val ? '^' + val + '$' : '', true, false).draw();
                    });
            });
        }

        function updateDropdowns(api) {
            api.columns().every(function() {
                let column = this;
                let select = $('#filterRow th').eq(column.index()).find('select');
                let currentVal = select.val();
                let uniqueVals = column.data().unique().sort().toArray();
                let options = '<option value="">All</option>';
                uniqueVals.forEach(d => {
                    if(d) {
                        let display = d.toString();
                        options += `<option value="${display}" ${display === currentVal ? 'selected' : ''}>${display}</option>`;
                    }
                });
                select.html(options);
            });
        }

        function clearAllFilters() {
            $('.column-select').val('');
            table.columns().search('').draw();
        }

        function toggleRefresh() { isPaused = !isPaused; $('#refreshBtn').toggleClass('btn-danger btn-success').text(isPaused ? "Start" : "Stop"); }
        function resetLayout() { window.location.reload(); }

        function changeLayout(v) {
            if (v === 'greeks') {
                table.columns([3,4,17,18]).visible(false);
                table.columns([5,6,7,8,13,14,15,16]).visible(true);
            } else if (v === 'oi_vol') {
                table.columns([5,6,7,8,13,14,15,16]).visible(false);
                table.columns([3,4,17,18]).visible(true);
            } else {
                table.columns().visible(true);
            }
        }
    </script>
</body>
</html>